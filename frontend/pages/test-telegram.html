<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Telegram - MAKERHUB</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f0f23;
      color: #fff;
      min-height: 100vh;
      padding: 40px;
    }
    
    h1 {
      color: #ffd600;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .test-section {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid #333;
    }
    
    .test-section h2 {
      color: #ffd600;
      margin-bottom: 16px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .input-group {
      margin-bottom: 16px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 6px;
      color: #aaa;
      font-size: 14px;
    }
    
    .input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #0f0f23;
      color: #fff;
      font-size: 14px;
    }
    
    .input-group input:focus {
      outline: none;
      border-color: #ffd600;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn-primary {
      background: #ffd600;
      color: #000;
    }
    
    .btn-primary:hover {
      background: #e6c200;
      transform: translateY(-2px);
    }
    
    .btn-danger {
      background: #ff4444;
      color: #fff;
    }
    
    .btn-danger:hover {
      background: #cc3333;
    }
    
    .btn-success {
      background: #00c853;
      color: #fff;
    }
    
    .btn-success:hover {
      background: #00a844;
    }
    
    .btn-info {
      background: #2196f3;
      color: #fff;
    }
    
    .btn-info:hover {
      background: #1976d2;
    }
    
    .result-box {
      background: #0a0a15;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .result-box.success {
      border-color: #00c853;
      background: rgba(0, 200, 83, 0.1);
    }
    
    .result-box.error {
      border-color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-ok { background: #00c853; }
    .status-error { background: #ff4444; }
    .status-pending { background: #ffd600; }
    
    .info-box {
      background: rgba(33, 150, 243, 0.1);
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #90caf9;
    }
    
    .warning-box {
      background: rgba(255, 214, 0, 0.1);
      border: 1px solid #ffd600;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #ffd600;
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    @media (max-width: 600px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test Telegram - MAKERHUB V1</h1>
    
    <div class="info-box">
      ‚ÑπÔ∏è <strong>Cette page permet de tester les fonctionnalit√©s Telegram de votre projet.</strong><br>
      Assurez-vous que les services Node.js (port 3000) et Python (port 5001) sont lanc√©s.
    </div>

    <!-- Health Check -->
    <div class="test-section">
      <h2>‚ù§Ô∏è Health Check Services</h2>
      <button class="btn btn-info" onclick="checkNodeHealth()">Test Node.js (3000)</button>
      <button class="btn btn-info" onclick="checkPythonHealth()">Test Python (5001)</button>
      <button class="btn btn-success" onclick="checkAllHealth()">Test Tous</button>
      <div id="healthResult" class="result-box" style="display:none;"></div>
    </div>

    <!-- Channel Info -->
    <div class="test-section">
      <h2>üì¢ R√©cup√©rer Info Canal</h2>
      <div class="input-group">
        <label>Lien du canal Telegram</label>
        <input type="text" id="channelLink" placeholder="https://t.me/+xxx ou @username">
      </div>
      <button class="btn btn-primary" onclick="getChannelId()">R√©cup√©rer ID Canal</button>
      <button class="btn btn-info" onclick="checkBotAdmin()">V√©rifier Bot Admin</button>
      <div id="channelResult" class="result-box" style="display:none;"></div>
    </div>

    <!-- Create Invite Link -->
    <div class="test-section">
      <h2>üîó Cr√©er Lien d'Invitation</h2>
      <div class="grid-2">
        <div class="input-group">
          <label>Channel ID</label>
          <input type="text" id="inviteChannelId" placeholder="-1001234567890">
        </div>
        <div class="input-group">
          <label>User Telegram ID (optionnel)</label>
          <input type="text" id="inviteUserId" placeholder="123456789">
        </div>
      </div>
      <div class="grid-2">
        <div class="input-group">
          <label>Dur√©e (heures)</label>
          <input type="number" id="expireHours" value="24">
        </div>
        <div class="input-group">
          <label>Limite membres</label>
          <input type="number" id="memberLimit" value="1">
        </div>
      </div>
      <button class="btn btn-primary" onclick="createInviteLink()">Cr√©er Lien</button>
      <div id="inviteResult" class="result-box" style="display:none;"></div>
    </div>

    <!-- Add Member -->
    <div class="test-section">
      <h2>‚ûï Ajouter Membre au Canal</h2>
      <div class="grid-2">
        <div class="input-group">
          <label>Page ID (Landing Page)</label>
          <input type="text" id="addPageId" placeholder="abc123xyz">
        </div>
        <div class="input-group">
          <label>Telegram User ID</label>
          <input type="text" id="addTelegramUserId" placeholder="123456789">
        </div>
      </div>
      <div class="input-group">
        <label>Email (optionnel)</label>
        <input type="text" id="addEmail" placeholder="user@example.com">
      </div>
      <button class="btn btn-success" onclick="addMember()">Ajouter Membre</button>
      <div id="addResult" class="result-box" style="display:none;"></div>
    </div>

    <!-- Remove Member -->
    <div class="test-section">
      <h2>‚ûñ Retirer Membre du Canal</h2>
      <div class="grid-2">
        <div class="input-group">
          <label>Page ID (Landing Page)</label>
          <input type="text" id="removePageId" placeholder="abc123xyz">
        </div>
        <div class="input-group">
          <label>Telegram User ID</label>
          <input type="text" id="removeTelegramUserId" placeholder="123456789">
        </div>
      </div>
      <button class="btn btn-danger" onclick="removeMember()">Retirer Membre</button>
      <div id="removeResult" class="result-box" style="display:none;"></div>
    </div>

    <!-- Simulate Payment Webhook -->
    <div class="test-section">
      <h2>üí≥ Simuler Paiement (Test Webhook Flow)</h2>
      <div class="warning-box">
        ‚ö†Ô∏è Ceci simule le flux apr√®s un paiement Stripe r√©ussi. 
        En production, c'est le webhook Stripe qui d√©clenche automatiquement l'ajout au canal.
      </div>
      <div class="grid-2">
        <div class="input-group">
          <label>Page ID</label>
          <input type="text" id="simPageId" placeholder="abc123xyz">
        </div>
        <div class="input-group">
          <label>Telegram User ID</label>
          <input type="text" id="simTelegramId" placeholder="123456789">
        </div>
      </div>
      <div class="input-group">
        <label>Email Client</label>
        <input type="text" id="simEmail" placeholder="client@example.com">
      </div>
      <button class="btn btn-primary" onclick="simulatePayment()">üöÄ Simuler Paiement Complet</button>
      <div id="simResult" class="result-box" style="display:none;"></div>
    </div>

    <!-- Logs -->
    <div class="test-section">
      <h2>üìã Logs de Test</h2>
      <button class="btn btn-info" onclick="clearLogs()">Effacer Logs</button>
      <div id="logsBox" class="result-box" style="min-height: 200px;">En attente de tests...</div>
    </div>
  </div>

  <script>
    // Base URLs
    const NODE_URL = 'http://localhost:3000';
    const PYTHON_URL = 'http://localhost:5001';

    // Logging
    function log(message, type = 'info') {
      const logsBox = document.getElementById('logsBox');
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
      logsBox.textContent += `\n[${timestamp}] ${prefix} ${message}`;
      logsBox.scrollTop = logsBox.scrollHeight;
    }

    function clearLogs() {
      document.getElementById('logsBox').textContent = 'Logs effac√©s...';
    }

    function showResult(elementId, data, isError = false) {
      const el = document.getElementById(elementId);
      el.style.display = 'block';
      el.className = 'result-box ' + (isError ? 'error' : 'success');
      el.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
    }

    // Health Checks
    async function checkNodeHealth() {
      try {
        log('V√©rification Node.js...');
        const res = await fetch(`${NODE_URL}/api/health`);
        const data = await res.json();
        showResult('healthResult', data);
        log('Node.js OK', 'success');
      } catch (e) {
        showResult('healthResult', 'Erreur: ' + e.message, true);
        log('Node.js ERREUR: ' + e.message, 'error');
      }
    }

    async function checkPythonHealth() {
      try {
        log('V√©rification Python...');
        const res = await fetch(`${PYTHON_URL}/api/health`);
        const data = await res.json();
        showResult('healthResult', data);
        log('Python OK', 'success');
      } catch (e) {
        showResult('healthResult', 'Erreur: ' + e.message, true);
        log('Python ERREUR: ' + e.message, 'error');
      }
    }

    async function checkAllHealth() {
      const results = {};
      
      try {
        const nodeRes = await fetch(`${NODE_URL}/api/health`);
        results.node = await nodeRes.json();
        log('Node.js OK', 'success');
      } catch (e) {
        results.node = { error: e.message };
        log('Node.js ERREUR', 'error');
      }
      
      try {
        const pythonRes = await fetch(`${PYTHON_URL}/api/health`);
        results.python = await pythonRes.json();
        log('Python OK', 'success');
      } catch (e) {
        results.python = { error: e.message };
        log('Python ERREUR', 'error');
      }
      
      showResult('healthResult', results);
    }

    // Channel Info
    async function getChannelId() {
      const channelLink = document.getElementById('channelLink').value;
      if (!channelLink) {
        alert('Veuillez entrer un lien de canal');
        return;
      }
      
      try {
        log('R√©cup√©ration ID canal: ' + channelLink);
        const res = await fetch(`${PYTHON_URL}/api/telegram/get-channel-id`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel_link: channelLink })
        });
        const data = await res.json();
        showResult('channelResult', data, !data.success);
        
        if (data.channel_id) {
          document.getElementById('inviteChannelId').value = data.channel_id;
          log('ID Canal r√©cup√©r√©: ' + data.channel_id, 'success');
        }
      } catch (e) {
        showResult('channelResult', 'Erreur: ' + e.message, true);
        log('Erreur: ' + e.message, 'error');
      }
    }

    async function checkBotAdmin() {
      const channelLink = document.getElementById('channelLink').value;
      if (!channelLink) {
        alert('Veuillez entrer un lien de canal');
        return;
      }
      
      try {
        log('V√©rification bot admin...');
        const res = await fetch(`${PYTHON_URL}/api/telegram/check-bot-admin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ channel_link: channelLink })
        });
        const data = await res.json();
        showResult('channelResult', data, !data.is_admin);
        log(data.is_admin ? 'Bot est admin ‚úÖ' : 'Bot PAS admin ‚ùå', data.is_admin ? 'success' : 'error');
      } catch (e) {
        showResult('channelResult', 'Erreur: ' + e.message, true);
        log('Erreur: ' + e.message, 'error');
      }
    }

    // Create Invite Link
    async function createInviteLink() {
      const channelId = document.getElementById('inviteChannelId').value;
      const userId = document.getElementById('inviteUserId').value;
      const expireHours = document.getElementById('expireHours').value;
      const memberLimit = document.getElementById('memberLimit').value;
      
      if (!channelId) {
        alert('Veuillez entrer un Channel ID');
        return;
      }
      
      try {
        log('Cr√©ation lien invitation...');
        const res = await fetch(`${PYTHON_URL}/api/telegram/create-invite-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            channel_id: channelId,
            user_telegram_id: userId || null,
            expire_hours: parseInt(expireHours),
            member_limit: parseInt(memberLimit)
          })
        });
        const data = await res.json();
        showResult('inviteResult', data, !data.success && !data.invite_link);
        log(data.invite_link ? 'Lien cr√©√©: ' + data.invite_link : 'Erreur cr√©ation lien', data.invite_link ? 'success' : 'error');
      } catch (e) {
        showResult('inviteResult', 'Erreur: ' + e.message, true);
        log('Erreur: ' + e.message, 'error');
      }
    }

    // Add Member
    async function addMember() {
      const pageId = document.getElementById('addPageId').value;
      const telegramUserId = document.getElementById('addTelegramUserId').value;
      const email = document.getElementById('addEmail').value;
      
      if (!pageId || !telegramUserId) {
        alert('Veuillez remplir Page ID et Telegram User ID');
        return;
      }
      
      try {
        log('Ajout membre au canal...');
        const res = await fetch(`${PYTHON_URL}/api/telegram/add-member`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            page_id: pageId,
            telegram_user_id: telegramUserId,
            email: email || ''
          })
        });
        const data = await res.json();
        showResult('addResult', data, !!data.error);
        log(data.error ? 'Erreur ajout: ' + data.error : 'Membre ajout√© !', data.error ? 'error' : 'success');
      } catch (e) {
        showResult('addResult', 'Erreur: ' + e.message, true);
        log('Erreur: ' + e.message, 'error');
      }
    }

    // Remove Member
    async function removeMember() {
      const pageId = document.getElementById('removePageId').value;
      const telegramUserId = document.getElementById('removeTelegramUserId').value;
      
      if (!pageId || !telegramUserId) {
        alert('Veuillez remplir Page ID et Telegram User ID');
        return;
      }
      
      if (!confirm('√ätes-vous s√ªr de vouloir retirer ce membre ?')) {
        return;
      }
      
      try {
        log('Retrait membre du canal...');
        const res = await fetch(`${PYTHON_URL}/api/telegram/remove-member`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            page_id: pageId,
            telegram_user_id: telegramUserId
          })
        });
        const data = await res.json();
        showResult('removeResult', data, !!data.error);
        log(data.error ? 'Erreur retrait: ' + data.error : 'Membre retir√© !', data.error ? 'error' : 'success');
      } catch (e) {
        showResult('removeResult', 'Erreur: ' + e.message, true);
        log('Erreur: ' + e.message, 'error');
      }
    }

    // Simulate Payment
    async function simulatePayment() {
      const pageId = document.getElementById('simPageId').value;
      const telegramId = document.getElementById('simTelegramId').value;
      const email = document.getElementById('simEmail').value;
      
      if (!pageId || !telegramId) {
        alert('Veuillez remplir Page ID et Telegram User ID');
        return;
      }
      
      try {
        log('=== SIMULATION PAIEMENT ===');
        log('1. Cr√©ation lien invitation...');
        
        // Step 1: Get page info to find channel
        const pageRes = await fetch(`${NODE_URL}/api/landing/${pageId}`);
        const pageData = await pageRes.json();
        
        if (!pageData.telegramChannelId) {
          throw new Error('Pas de canal Telegram connect√© √† cette page');
        }
        
        log('Page trouv√©e, canal: ' + pageData.telegramChannelId);
        
        // Step 2: Create invite link
        const inviteRes = await fetch(`${PYTHON_URL}/api/telegram/create-invite-link`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            channel_id: pageData.telegramChannelId,
            user_telegram_id: telegramId,
            expire_hours: 24,
            member_limit: 1
          })
        });
        const inviteData = await inviteRes.json();
        
        if (inviteData.invite_link) {
          log('2. Lien cr√©√©: ' + inviteData.invite_link, 'success');
        }
        
        // Step 3: Add member to tracking
        log('3. Enregistrement membre...');
        const addRes = await fetch(`${PYTHON_URL}/api/telegram/add-member`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            page_id: pageId,
            telegram_user_id: telegramId,
            email: email
          })
        });
        const addData = await addRes.json();
        
        log('=== SIMULATION TERMIN√âE ===', 'success');
        
        showResult('simResult', {
          step1_page: pageData.brand || pageData.channelName,
          step2_invite: inviteData,
          step3_member: addData,
          message: 'Simulation r√©ussie ! En production, le webhook Stripe fait tout √ßa automatiquement.'
        });
        
      } catch (e) {
        showResult('simResult', 'Erreur simulation: ' + e.message, true);
        log('Erreur: ' + e.message, 'error');
      }
    }

    // Init
    log('Page de test charg√©e. Lancez vos tests !');
  </script>
</body>
</html>