<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment Plans - MAKERHUB</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/plans.css">
</head>
<body>

<div class="dashboard-container">
  <!-- Mobile Menu Toggle -->
  <button class="menu-toggle" id="menuToggle">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar Container -->
  <div id="sidebar-container"></div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="content-wrapper">
      <div class="page-header">
        <div>
          <h1 class="page-title">Choose Your Plan</h1>
          <p class="page-description">Grow your business with the right plan. Start free and scale as needed.</p>
        </div>
        <button class="btn-logout" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>

      <!-- PRICING CARDS -->
      <div class="pricing-grid">
        
        <!-- PLAN FREEMIUM -->
        <div class="pricing-card">
          <div class="plan-header">
            <div class="plan-name">Freemium</div>
            <div class="plan-price">
              <span class="price-currency">$</span>
              <span class="price-amount">0</span>
              <span class="price-period">/month</span>
            </div>
            <div class="commission-info">
              Commission: <span class="commission-rate">10%</span> on all sales
            </div>
          </div>
          
          <ul class="features-list">
            <li>Telegram Membership</li>
            <li>Statistics</li>
            <li class="disabled">Telegram Translation</li>
            <li class="disabled">Telegram Funnel <span class="coming-soon-tag">Coming Soon</span></li>
            <li class="disabled">Calendar & Bookings <span class="coming-soon-tag">Coming Soon</span></li>
            <li class="disabled">Email Marketing <span class="coming-soon-tag">Coming Soon</span></li>
          </ul>
          
          <button class="plan-cta cta-secondary">Start Free</button>
        </div>

        <!-- Plan Pro -->
        <div class="pricing-card popular">
          <div class="popular-badge">Most Popular</div>
          <div class="plan-header">
            <div class="plan-name">Pro</div>
            <div class="plan-price">
              <span class="price-currency">$</span>
              <span class="price-amount">49</span>
              <span class="price-period">/month</span>
            </div>
          </div>
          
          <ul class="features-list">
            <li>Telegram Membership (4%)</li>
            <li>Statistics</li>
            <li>Calendar & Bookings <span class="coming-soon-tag">Coming Soon</span></li>
            <li>Email Marketing <span class="coming-soon-tag">Coming Soon</span></li>
            <li class="disabled">Telegram Translation</li>
            <li class="disabled">Telegram Funnel <span class="coming-soon-tag">Coming Soon</span></li>
          </ul>
          
          <button class="plan-cta cta-primary">Upgrade to Pro</button>
        </div>

        <!-- Plan Business -->
        <div class="pricing-card">
          <div class="plan-header">
            <div class="plan-name">Business</div>
            <div class="plan-price">
              <span class="price-currency">$</span>
              <span class="price-amount">99</span>
              <span class="price-period">/month</span>
            </div>
          </div>
          
          <ul class="features-list">
            <li>Unlimited Telegram Channels (2%)</li>
            <li>Statistics</li>
            <li>Telegram Translation <span class="coming-soon-tag">Coming Soon</span></li>
            <li>Calendar & Bookings <span class="coming-soon-tag">Coming Soon</span></li>
            <li>Email Marketing <span class="coming-soon-tag">Coming Soon</span></li>
            <li>Telegram Funnel <span class="coming-soon-tag">Coming Soon</span></li>
          </ul>
          
          <button class="plan-cta cta-primary">Upgrade to Business</button>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>

<!-- Firebase Config -->
<script src="/config/firebase.js"></script>

<!-- MAKERHUB Config -->
<script>
    window.MAKERHUB_CONFIG = {
        NODE_API_URL: 'http://localhost:3000',
        NODE_ENV: 'development'
    };
</script>

<!-- Sidebar Component -->
<script src="/assets/js/sidebar.js"></script>

<!-- Logout Script -->
<script>
  document.getElementById('logoutBtn')?.addEventListener('click', () => {
    firebase.auth().signOut().then(() => {
      window.location.href = '/auth.html';
    });
  });
</script>

<!-- Subscription Script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const API_URL = window.MAKERHUB_CONFIG?.NODE_API_URL || 'https://makerhub.pro';
    
    // VÃ©rifier si succÃ¨s ou annulation
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
      const plan = urlParams.get('plan');
      alert(`ðŸŽ‰ FÃ©licitations ! Vous Ãªtes maintenant abonnÃ© au plan ${plan} !`);
      window.history.replaceState({}, document.title, '/plans.html');
    }
    if (urlParams.get('canceled') === 'true') {
      alert('Paiement annulÃ©.');
      window.history.replaceState({}, document.title, '/plans.html');
    }

    // Fonction pour s'abonner
    async function subscribeToPlan(plan) {
      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Veuillez vous connecter pour vous abonner.');
          window.location.href = '/auth.html';
          return;
        }

        const token = await user.getIdToken();

        const response = await fetch(`${API_URL}/api/subscription/create-checkout`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ plan: plan })
        });

        const data = await response.json();

        if (data.success && data.url) {
          window.location.href = data.url;
        } else {
          alert(data.error || 'Erreur lors de la crÃ©ation de l\'abonnement');
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de connexion. Veuillez rÃ©essayer.');
      }
    }

    // Attacher les Ã©vÃ©nements aux boutons
    const buttons = document.querySelectorAll('.plan-cta');
    buttons.forEach(btn => {
      const card = btn.closest('.pricing-card');
      const planName = card.querySelector('.plan-name')?.textContent?.toLowerCase();
      
      btn.addEventListener('click', () => {
        if (planName === 'freemium') {
          // Plan gratuit - juste continuer
          window.location.href = '/dashboard.html';
        } else if (planName === 'pro' || planName === 'business') {
          subscribeToPlan(planName);
        }
      });
    });

    // Charger le statut actuel
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        try {
          const token = await user.getIdToken();
          const response = await fetch(`${API_URL}/api/subscription/status`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          const data = await response.json();
          
          if (data.success && data.plan !== 'freemium') {
            // Marquer le plan actuel
            const cards = document.querySelectorAll('.pricing-card');
            cards.forEach(card => {
              const name = card.querySelector('.plan-name')?.textContent?.toLowerCase();
              if (name === data.plan) {
                const btn = card.querySelector('.plan-cta');
                if (btn) {
                  btn.textContent = 'âœ“ Plan actuel';
                  btn.disabled = true;
                  btn.style.opacity = '0.7';
                }
              }
            });
          }
        } catch (error) {
          console.error('Erreur chargement statut:', error);
        }
      }
    });
  });
</script>

</body>
</html>